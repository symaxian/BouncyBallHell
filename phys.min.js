var star,$;
(function(){function s(a,c,f){this.x=a;this.y=c;this.setType(f)}function t(){this.bodies=[]}s.prototype={type:null,canMove:!0,cell:null,x:0,y:0,vx:0,vy:0,fx:0,fy:0,ax:0,ay:0,applyForce:function(a){this.ax=this.fx/this.mass;this.ay=this.fy/this.mass;this.vx+=this.ax*a;this.vy+=this.ay*a;this.x+=this.vx*a;this.y+=this.vy*a;this.fy=this.fx=0},setType:function(a){this.type=a;this.radius=star.classes[a].diameter/2;this.mass=star.classes[a].mass;this.threshold=star.classes[a].threshold}};t.prototype={bodies:null,
x:0,y:0,mass:0,massX:0,massY:0,reset:function(a,c){this.x=a;this.y=c;this.massY=this.massX=this.mass=0;this.bodies.length=0}};window.star={SIMULATION_INTERVAL_TIME:20,MAX_DISPLAY_WIDTH:1920,MAX_DISPLAY_HEIGHT:1080,MAX_SIMULATION_STEP_TIME:30,INIT_GRID_CELL_SIZE:12E3,LEFT_CLICK_BODY_CLASS:8,particleCount:3E3,frameInterval:null,simTime:null,drawTime:null,enableAutomaticGridSizing:!0,running:!1,flipNextCollisionCheckDirection:!1,bodies:[],gravity:0.0025,wallBounce:-0.8,wallFrict:0.8,particleBounce:0.7,
drawGrid:!1,drawCellMass:!1,drawCellCenterOfMass:!1,particleDrawSizeMultiplier:0.8,classes:[{},{color:"Black",diameter:3,mass:20,threshold:1E6,count:0},{color:"Purple",diameter:4,mass:30,threshold:3E6,count:0},{color:"Blue",diameter:5,mass:40,threshold:8E6,count:0},{color:"Green",diameter:6,mass:50,threshold:12E6,count:0},{color:"Yellow",diameter:7,mass:60,threshold:25E6,count:0},{color:"Orange",diameter:8,mass:70,threshold:36E6,count:0},{color:"Red",diameter:10,mass:80,threshold:49E6,count:0},{color:"Pink",
diameter:20,mass:-1E4}],init:function(){star.canvas=document.getElementById("canvas");star.setGridCellSize(12E3);document.body.onresize=star.updateCanvasSize;star.updateCanvasSize();star.ctx=star.canvas.getContext("2d");star.canvas.onmousedown=function(a){var c=(star.canvas.offsetWidth-star.width)/2;a=new s(a.clientX-star.canvas.offsetLeft-c,a.clientY-star.canvas.offsetTop-c,8);a.canMove=!1;star.bodies.push(a)};star.canvas.onmouseup=function(){star.bodies.pop()};star.ui.init();star.restart()},updateCanvasSize:function(){var a=
document.getElementById("canvasContainer"),c=a.offsetWidth-40,a=a.offsetHeight-40;c>window.innerWidth&&(c=window.innerWidth-40);a>window.innerHeight&&(a=window.innerHeight-40);1920<c&&(c=1920);1080<a&&(a=1080);a<document.body.clientHeight-40&&(a=document.body.clientHeight-40);star.width=c;star.height=a;star.canvas.width=c;star.canvas.height=a},stepSimulation:function(){var a=Date.now(),c=a-star.lastTime;star.lastTime=a;star.running&&(30<c&&(c=30),a=Date.now(),star.moveConstrainsAll(),star.moveForceAll(c),
star.simTime=Date.now()-a,star.previousGridCellSizes.push(star.gridCellSize),star.previousSimTimes.push(star.simTime),20<star.previousGridCellSizes.length&&(star.previousGridCellSizes.shift(),star.previousSimTimes.shift()),a=Date.now(),star.render(),star.drawTime=Date.now()-a)},start:function(){star.lastTime=Date.now();star.frameInterval=setInterval(star.stepSimulation,20);star.enableAutomaticGridSizing&&star.startGridSizingRoutine();star.running=!0},stop:function(){clearInterval(star.frameInterval);
star.clearGridSizingRoutine();star.running=!1},restart:function(){var a;star.setGridCellSize(star.defaultCellSize);for(a=0;a<star.classes.length;a++)star.classes[a].count=0;star.classes[1].count=star.particleCount;star.bodies=[];for(a=star.particleCount-1;0<=a;a--)star.bodies.push(new s(Math.random()*star.width,Math.random()*star.height,1));star.ui.updateClassCounts();star.start()},cells:[],cellCount:0,columns:null,rows:null,cellWidth:null,cellHeight:null,constrainAndSortBodies:function(){var a=star.cells,
c=star.bodies,f,b,d,g,k=star.width,e=star.height,h=star.columnCount,m=star.rowCount,l=star.cellWidth,p=star.cellHeight,n=star.wallBounce,q=star.wallFrict;for(f=star.cellCount-1;0<=f;f--)d=a[f],d.bodies.length=0,d.mass=0,d.massX=0,d.massY=0;for(f=c.length-1;0<=f;f--)b=c[f],0>b.x?(b.x=0,b.vx*=n,b.vy*=q):b.x>k&&(b.x=k,b.vx*=n,b.vy*=q),0>b.y?(b.y=0,b.vy*=n,b.vx*=q):b.y>e&&(b.y=e,b.vy*=n,b.vx*=q),d=b.x/l|0,g=b.y/p|0,d===h&&d--,g===m&&g--,d=g*h+d,d=a[d],d.bodies.push(b),d.mass+=b.mass,d.massX+=b.x*b.mass,
d.massY+=b.y*b.mass,b.cell=d;for(f=star.cellCount-1;0<=f;f--)d=a[f],d.massX/=d.mass,d.massY/=d.mass},setGridSize:function(a,c){var f,b;star.columnCount=a;star.rowCount=c;star.cellWidth=star.width/a;star.cellHeight=star.height/c;for(star.cellCount=a*c;star.cells.length<star.cellCount;)star.cells.push(new t);for(f=c-1;0<=f;f--)for(b=a-1;0<=b;b--)star.cells[f*a+b].reset(b*star.cellWidth,f*star.cellHeight,star.cellWidth,star.cellHeight);star.ui.setGridSize(a,c);star.gridCellSize=star.cellWidth*star.cellHeight},
previousGridCellSizes:[],previousSimTimes:[],defaultCellSize:1E4,gridSizingInterval:null,GRID_RESIZE_INTERVAL:50,GRID_SIZING_VARIANCE:0.1,PREVIOUS_GRID_CELL_SIZES_MAX_SIZE:20,setAutomaticGridSizing:function(a){a&&!star.enableAutomaticGridSizing?star.startGridSizingRoutine():!a&&star.enableAutomaticGridSizing&&star.clearGridSizingRoutine();star.enableAutomaticGridSizing=a},startGridSizingRoutine:function(){star.gridSizingInterval=setInterval(function(){var a=Infinity,c,f,b=star.defaultCellSize;if(star.previousGridCellSizes.length)for(c=
star.previousGridCellSizes.length-1;0<=c;c--)f=star.previousSimTimes[c],f<a&&(b=star.previousGridCellSizes[c],a=f);b=0.5>Math.random()?b+0.1*b:b-0.1*b;star.setGridCellSize(b)},50)},clearGridSizingRoutine:function(){null!==star.gridSizingInterval&&clearInterval(star.gridSizingInterval)},setGridCellSize:function(a){var c=star.width*star.height;a=c/(c/a);star.setGridSize(Math.round(star.width/Math.sqrt(a)),Math.round(star.height/Math.sqrt(a)))},moveForceAll:function(a){isNaN(a)&&(a=0.01);a*=star.gravity;
var c=star.bodies,f=star.cells,b,d,g,k,e,h,m,l,p;for(b=star.cellCount-1;0<=b;b--){g=f[b];d=g.bodies;m=g.mass;for(k=d.length-1;0<=k;k--)star.gravi(d[k],d);if(m)for(l=g.massX,p=g.massY,k=c.length-1;0<=k;k--)d=c[k],d.cell!==g&&(e=d.x-l,h=d.y-p,e=e*e+h*h,h=2*d.mass*m/e,d.fx-=h*(d.x-g.massX)/Math.sqrt(e),d.fy-=h*(d.y-g.massY)/Math.sqrt(e))}for(b=c.length-1;0<=b;b--)d=c[b],d.canMove&&d.applyForce(a)},gravi:function(a,c){var f=a.x,b=a.y,d=a.mass,g,k,e,h;for(e=c.length-1;0<=e;e--)h=c[e],a!==h&&(g=f-h.x,k=
b-h.y,g&&k&&(g=g*g+k*k,k=2*d*h.mass/g,a.fx-=k*(a.x-h.x)/Math.sqrt(g),a.fy-=k*(a.y-h.y)/Math.sqrt(g)))},collisions:function(a){var c,f,b,d,g,k,e,h,m,l,p,n,q,r=star.particleBounce;for(c=a.length-1;0<=c;c--)if(b=a[c],b.canMove){d=b.x;g=b.y;k=b.radius;for(f=c+1;f<a.length;f++)e=a[f],e.canMove&&(h=d-e.x,m=g-e.y,h=h*h+m*m,0!==h&&h<(k+e.radius)*(k+e.radius)&&(m=b.mass*(b.vx*b.vx+b.vy*b.vy)+e.mass*(e.vx*e.vx+e.vy*e.vy),m>b.threshold+e.threshold&&7>=b.type+e.type?(h=star.bodies.indexOf(e),star.bodies.splice(h,
1),star.classes[b.type].count--,star.classes[e.type].count--,star.classes[b.type+e.type].count++,b.setType(b.type+e.type),star.ui.updateClassCounts(),b.vx*=e.mass/b.mass,b.vy*=e.mass/b.mass):(l=b.mass/e.mass/2+0.5,p=Math.sqrt(h),h=(e.x-d)/p,m=(e.y-g)/p,n=(e.vx-b.vx)*h+(e.vy-b.vy)*m,q=n*h,n*=m,e.vx+=r*q*(1-l)/l-q,e.vy+=r*n*(1-l)/l-n,b.vx+=r*q/l,b.vy+=r*n/l,l=(k+e.radius-p)/2,e.x+=l*h,e.y+=l*m,d-=l*h,g-=l*m)));b.x=d;b.y=g}},moveConstrainsAll:function(){var a=star.cells,c;star.constrainAndSortBodies();
for(c=star.cellCount-1;0<=c;c--)star.collisions(a[c].bodies)},render:function(){var a=star.bodies,c,f=star.ctx,b,d,g=NaN;f.clearRect(0,0,star.width,star.height);if(star.drawGrid)for(c=star.cells,f.strokeStyle="white",f.fillStyle="red",b=star.cellCount-1;0<=b;b--)d=c[b],f.strokeRect(d.x,d.y,star.cellWidth,star.cellHeight),star.drawCellMass&&f.fillText(d.mass+"",d.x+2,d.y+10),star.drawCellCenterOfMass&&d.mass&&f.fillRect(d.massX-2,d.massY-2,4,4);for(b=a.length-1;0<=b;b--)c=a[b],g!==c.type&&(f.fillStyle=
star.classes[c.type].color,g=c.type),f.beginPath(),f.arc(c.x,c.y,c.radius*star.particleDrawSizeMultiplier,0,2*Math.PI,!0),f.fill()},updateParticles:function(){for(var a=star.bodies.length-1;0<=a;a--)star.bodies[a].setType(star.bodies[a].type)},ui:{init:function(){this.cpMain=document.getElementById("cp-main");for(var a=document.getElementsByClassName("header-button"),c=0;c<a.length;c++)a[c].onclick=function(a){a=$("#"+a.target.getAttribute("data-toggle"));a.is(":visible")?a.hide():a.show()};$("#restart").click(star.restart);
var f=$("#pause");f.click(function(){star.running?(star.stop(),f.text("Resume")):(star.start(),f.text("Pause"))});$("#cp-main-count").val(star.particleCount);$("#cp-main-count").change(function(a){star.particleCount=parseInt($(a.target).val(),10)});$("#cp-physics-gravity").val(star.gravity);$("#cp-physics-gravity").change(function(a){star.gravity=parseFloat($(a.target).val())});$("#cp-physics-particleBounce").val(star.particleBounce);$("#cp-physics-particleBounce").change(function(a){star.particleBounce=
parseFloat($(a.target).val())});$("#cp-physics-wallBounce").val(star.wallBounce);$("#cp-physics-wallBounce").change(function(a){star.wallBounce=parseFloat($(a.target).val())});$("#cp-physics-wallFrict").val(star.wallFrict);$("#cp-physics-wallFrict").change(function(a){star.wallFrict=parseFloat($(a.target).val())});c=$("#enableAutomaticGridSizing");c.attr("checked",star.enableAutomaticGridSizing);star.enableAutomaticGridSizing&&($("#cp-gridSize-columns").attr("disabled",!0),$("#cp-gridSize-rows").attr("disabled",
!0));c.change(function(a){a=a.target.checked;star.setAutomaticGridSizing(a);a?($("#cp-gridSize-columns").attr("disabled",!0),$("#cp-gridSize-rows").attr("disabled",!0),star.ui.setGridSize(star.columnCount,star.rowCount)):($("#cp-gridSize-columns").attr("disabled",!1),$("#cp-gridSize-rows").attr("disabled",!1))});$("#cp-gridSize-columns").change(function(a){star.setGridSize(parseInt($(a.target).val(),10),star.rowCount)});$("#cp-gridSize-rows").change(function(a){star.setGridSize(star.columnCount,parseInt($(a.target).val(),
10))});$("#cp-drawGrid")[0].checked=star.drawGrid;$("#cp-drawGrid").change(function(a){star.drawGrid=a.target.checked});$("#cp-drawCellMass")[0].checked=star.drawCellMass;$("#cp-drawCellMass").change(function(a){star.drawCellMass=a.target.checked});$("#cp-drawCellCenterOfMass")[0].checked=star.drawCellCenterOfMass;$("#cp-drawCellCenterOfMass").change(function(a){star.drawCellCenterOfMass=a.target.checked});$("#cp-rendering-particleDrawSizeMultiplier").val(star.particleDrawSizeMultiplier);$("#cp-rendering-particleDrawSizeMultiplier").change(function(a){star.particleDrawSizeMultiplier=
parseFloat($(a.target).val())});setInterval(function(){$("#simTime").text(star.simTime);$("#drawTime").text(star.drawTime)},500);for(var b,c=0;c<star.classes.length-1;c++)a=star.classes[c],b=$("#cp-class"+c),b.length&&(b=$("#cp-class"+c+"-color"),b[0].data=a,b.val(a.color),b.change(function(a){a.target.data.color=$(a.target).val()}),b=$("#cp-class"+c+"-physicalDiameter"),b[0].data=a,b.val(a.diameter),b.change(function(a){a.target.data.diameter=parseInt($(a.target).val(),10);star.updateParticles()}),
b=$("#cp-class"+c+"-mass"),b[0].data=a,b.val(a.mass),b.change(function(a){a.target.data.mass=parseInt($(a.target).val(),10);star.updateParticles()}),b=$("#cp-class"+c+"-threshold"),b[0].data=a,b.val(a.threshold),b.change(function(a){a.target.data.threshold=parseInt($(a.target).val(),10);star.updateParticles()}))},setGridSize:function(a,c){$("#cp-gridSize-columns").val(a);$("#cp-gridSize-rows").val(c)},updateClassCounts:function(){for(var a=1;a<star.classes.length-1;a++)$("#class"+a+"_count").text(star.classes[a].count)}}}})();
